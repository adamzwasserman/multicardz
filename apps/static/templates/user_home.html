{% extends "base.html" %}

{% block content %}
<div class="spatial-grid" id="spatialGrid"
     {% if workspace_id %}data-workspace="{{ workspace_id }}"{% endif %}
     {% if user_id %}data-user="{{ user_id }}"{% endif %}>
    <!-- Row 1: Tag Management (Middle Column Only) -->
    <button class="collapse-toggle collapse-row1" onclick="toggleRow(1)" title="Toggle Row 1" aria-label="Toggle row 1">
        <svg class="chevron chevron-up" width="16" height="16" viewBox="0 0 16 16">
            <path d="M4 10L8 6L12 10" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </button>
    <div class="debug-group collapsible-row row-1" style="position: relative; display: none;">
        <label for="tagsInPlay">tags in play</label>
        <textarea class="tags-in-play" id="tagsInPlay" placeholder="waiting for zone activity..." aria-label="Tags in play" readonly rows="8">{"union":[],"intersection":[],"exclusion":[],"row":[],"column":[]}</textarea>
    </div>
    <div class="tag-management collapsible-row row-1" style="position: relative;">
        <div class="clouds-container horizontal" id="cloudsContainer" data-zone-type="tag-cloud" data-accepts="tags,group-tags">
            <!-- User Tags Cloud -->
            <div class="cloud cloud-user"
                 data-cloud-type="user"
>
                <div class="cloud-title cloud-title-user">
                    user tags<span class="tag-count">({{ available_tags|length }})</span>
                </div>
                <div class="tags-wrapper">
                    {% for tag in available_tags %}
                    <span class="tag tag-user"
                          data-tag="{{ tag.name }}"
                          data-tag-id="{{ tag.id }}"
                          data-type="tag"
                          draggable="true"
                          id="tag-{{ tag.name }}"
>
                        {{ tag.name }} ({{ tag.count }})
                        <button class="tag-delete" onclick="deleteTag('{{ tag.id }}', this)" title="Delete tag">×</button>
                    </span>
                    {% endfor %}
                </div>
                <div class="input-wrapper">
                    <input type="text" class="tag-input" placeholder="Add user tag..." aria-label="Add user tag"
>
                </div>
            </div>

            <!-- Secondary Tag Clouds Container -->
            <div class="clouds-secondary">
                <!-- AI Tags Cloud (Hidden in simple view, shown in advanced view) -->
                <div class="cloud cloud-ai" id="aiTagsCloud" style="display: none;"
                     data-cloud-type="ai"
>
                    <div class="cloud-title cloud-title-ai">
                        ai tags<span class="tag-count">(3)</span>
                    </div>
                    <div class="tags-wrapper">
                        <span class="tag tag-ai"
                              data-tag="machine-learning"
                              data-type="ai-tag"
                              draggable="true"
>
                            machine-learning
                        </span>
                        <span class="tag tag-ai"
                              data-tag="data-processing"
                              data-type="ai-tag"
                              draggable="true"
>
                            data-processing
                        </span>
                        <span class="tag tag-ai"
                              data-tag="automation"
                              data-type="ai-tag"
                              draggable="true"
>
                            automation
                        </span>
                    </div>
                    <div class="input-wrapper">
                        <input type="text" class="tag-input" placeholder="Add AI tag..." aria-label="Add AI tag"
>
                    </div>
                </div>

                <!-- Tag Groups Cloud -->
                <div class="cloud cloud-group">
                    <div class="cloud-title cloud-title-group">
                        tag groups<span class="tag-count">({{ groups|length }})</span>
                    </div>
                    <div class="tags-wrapper">
                        {% for group in groups %}
                        <span class="tag tag-group"
                              data-group="{{ group.id }}"
                              data-type="group-tag"
                              draggable="true"
>
                            {{ group.name }}
                        </span>
                        {% endfor %}
                    </div>
                    <div class="input-wrapper">
                        <input type="text" class="tag-input" placeholder="Add group..." aria-label="Add group"
>
                    </div>
                </div>

                <!-- System Tags Cloud -->
                <div class="cloud cloud-system">
                    <div class="cloud-title cloud-title-system">
                        system tags<span class="tag-count">(2)</span>
                    </div>
                    <div class="tags-wrapper">
                        <span class="tag tag-system" data-type="system-tag" draggable="true">Priority</span>
                        <span class="tag tag-system" data-type="system-tag" draggable="true">Archive</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 2: Control Areas (All 3 Columns) -->
    <button class="collapse-toggle collapse-row2" onclick="toggleRow(2)" title="Toggle Row 2" aria-label="Toggle row 2">
        <svg class="chevron chevron-up" width="16" height="16" viewBox="0 0 16 16">
            <path d="M4 10L8 6L12 10" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </button>
    <div class="universal-control collapsible-section collapsible-row row-2" style="position: relative;">
        <div class="section-header">
            <h3>global settings</h3>
            <button class="collapse-toggle collapse-universal" onclick="toggleSection('universal')" title="Toggle Universal Control" aria-label="Toggle universal control">
                <svg class="chevron chevron-up" width="16" height="16" viewBox="0 0 16 16">
                    <path d="M4 10L8 6L12 10" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>
        <div class="controls">

            <div class="database-group">
                <select id="databaseSelector" class="database-selector" aria-label="Database selector"
                        hx-get="/api/database-options"
                        hx-trigger="load"
                        hx-swap="innerHTML"
                        onchange="switchDatabase(this.value)">
                    <option value="">loading saved project...</option>
                </select>
                <label for="fontSelector">pick a project</label>
                <!-- <label for="databaseSelector">active database</label>
                <div class="database-info">
                    <span id="currentDatabaseInfo"
                          hx-get="/api/current-database-info"
                          hx-trigger="load"
                          hx-swap="innerHTML">Loading...</span>
                </div> -->
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="startWithAllCards" data-affects-rendering="true" onchange="if(typeof window.dragDropSystem !== 'undefined') window.dragDropSystem.updateStateAndRender()">
                <label for="startWithAllCards">start with all cards visible</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="startWithCardsExpanded" data-affects-rendering="true" checked onchange="if(typeof window.dragDropSystem !== 'undefined') window.dragDropSystem.updateStateAndRender()">
                <label for="startWithCardsExpanded">show tags on cards</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="showColors" data-affects-rendering="true" onchange="if(typeof window.dragDropSystem !== 'undefined') window.dragDropSystem.updateStateAndRender()">
                <label for="showColors">show colors on tags/card</label>
            </div>


        </div>
    </div>

    <div class="top-control collapsible-row row-2" style="position: relative;">
        <!-- Control areas are DROP TARGETS for zones -->
        <div class="control-area-container zone-container"
             ondragover="if(event.dataTransfer.types.includes('text/zone')) { event.preventDefault(); this.classList.add('zone-drag-over'); }"
             ondragleave="this.classList.remove('zone-drag-over')"
             ondrop="handleZoneDrop(event, this)">
            <!-- Filter zone container - NOT a drop zone, just a visual container -->
            <div class="filter-zone-container"
                 id="filter"
                 data-zone-type="filter"
                 draggable="true"
                 ondragstart="event.dataTransfer.setData('text/zone', 'filter')">
                <div class="zone-drag-handle" title="Drag to move zone">
                    <span class="drag-grip">⋮⋮</span>
                </div>

                <!-- Union Drop Zone (ANY) -->
                <div class="drop-zone filter-subzone union-zone"
                     id="union_tags"
                     data-zone-type="union"
                     data-accepts="tags,group-tags"
>
                    <span class="zone-label">SHOW cards with these tags</span>
                    <div class="tag-collection" id="union-tags-container"></div>
                </div>

                <!-- Red Dot Separator -->
                <div class="zone-separator">
                    <div class="separator-dot"></div>
                </div>

                <!-- Intersection Drop Zone (ALL) -->
                <div class="drop-zone filter-subzone intersection-zone"
                     id="intersection_tags"
                     data-zone-type="intersection"
                     data-accepts="tags,group-tags"
>
                    <span class="zone-label">FILTER cards by these tags</span>
                    <div class="tag-collection" id="intersection-tags-container"></div>
                </div>

                <!-- Red Dot Separator -->
                <div class="zone-separator">
                    <div class="separator-dot separator-dot-red"></div>
                </div>

                <!-- Exclusion Drop Zone (NONE) -->
                <div class="drop-zone filter-subzone exclusion-zone"
                     id="exclusion_tags"
                     data-zone-type="exclusion"
                     data-zone-behavior="exclusion"
                     data-accepts="tags,group-tags"
>
                    <span class="zone-label">HIDE cards with these tags</span>
                    <div class="tag-collection" id="exclusion-tags-container"></div>
                </div>

                <div class="zone-drag-handle zone-drag-handle-right" title="Drag to move zone">
                    <span class="drag-grip">⋮⋮</span>
                </div>
            </div>
        </div>
    </div>

    <div class="ui-control collapsible-section collapsible-row row-2" style="position: relative;">
        <div class="section-header">
            <h3>user interface</h3>
            <button class="collapse-toggle collapse-ui" onclick="toggleSection('ui')" title="Toggle User Interface" aria-label="Toggle user interface">
                <svg class="chevron chevron-up" width="16" height="16" viewBox="0 0 16 16">
                    <path d="M4 10L8 6L12 10" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>

        <div class="controls">
            <!-- Theme Switcher -->
            <div class="theme-switch-group">
                <label class="theme-label">theme picker</label>
                <div class="theme-radio-group">
                    <div class="theme-radio-item">
                        <input type="radio" id="theme-system" name="theme" value="system" checked
                               onclick="document.documentElement.style.colorScheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'; document.body.classList.remove('dark-mode', 'earth-tones'); saveThemeChoice('system');">
                        <label for="theme-system">system</label>
                    </div>
                    <div class="theme-radio-item">
                        <input type="radio" id="theme-light" name="theme" value="light"
                               onclick="document.documentElement.style.colorScheme = 'light'; document.body.classList.remove('dark-mode', 'earth-tones'); saveThemeChoice('light');">
                        <label for="theme-light">light</label>
                    </div>
                    <div class="theme-radio-item">
                        <input type="radio" id="theme-dark" name="theme" value="dark"
                               onclick="document.documentElement.style.colorScheme = 'dark'; document.body.classList.add('dark-mode'); document.body.classList.remove('earth-tones'); saveThemeChoice('dark');">
                        <label for="theme-dark">dark</label>
                    </div>
                    <div class="theme-radio-item">
                        <input type="radio" id="theme-earth" name="theme" value="earth"
                               onclick="document.documentElement.style.colorScheme = 'light'; document.body.classList.add('earth-tones'); document.body.classList.remove('dark-mode'); saveThemeChoice('earth');">
                        <label for="theme-earth">earth tones</label>
                    </div>
                </div>
            </div>

            <div class="font-group">
                <div class="font-dropdown-wrapper">
                    <label class="theme-label">font picker</label>
                    <div class="font-dropdown-current font-system" tabindex="0">System Sans</div>
                    <div class="font-dropdown-options">
                        <div class="font-dropdown-option font-system" onclick="this.parentNode.parentNode.querySelector('.font-dropdown-current').textContent = 'System Sans'; this.parentNode.parentNode.querySelector('.font-dropdown-current').className = 'font-dropdown-current font-system'; document.body.className = document.body.className.replace(/font-\w+/g, ''); saveFontChoice('font-system'); this.parentNode.parentNode.classList.remove('active');">System Sans</div>
                        <div class="font-dropdown-option font-inconsolata" onclick="this.parentNode.parentNode.querySelector('.font-dropdown-current').textContent = 'Inconsolata 200'; this.parentNode.parentNode.querySelector('.font-dropdown-current').className = 'font-dropdown-current font-inconsolata'; document.body.className = document.body.className.replace(/font-\w+/g, '') + ' font-inconsolata'; saveFontChoice('font-inconsolata'); this.parentNode.parentNode.classList.remove('active');">Inconsolata 200</div>
                        <div class="font-dropdown-option font-optima" onclick="this.parentNode.parentNode.querySelector('.font-dropdown-current').textContent = 'Lato'; this.parentNode.parentNode.querySelector('.font-dropdown-current').className = 'font-dropdown-current font-optima'; document.body.className = document.body.className.replace(/font-\w+/g, '') + ' font-optima'; saveFontChoice('font-optima'); this.parentNode.parentNode.classList.remove('active');">Lato</div>
                        <div class="font-dropdown-option font-helvetica" onclick="this.parentNode.parentNode.querySelector('.font-dropdown-current').textContent = 'Libre Franklin'; this.parentNode.parentNode.querySelector('.font-dropdown-current').className = 'font-dropdown-current font-helvetica'; document.body.className = document.body.className.replace(/font-\w+/g, '') + ' font-helvetica'; saveFontChoice('font-helvetica'); this.parentNode.parentNode.classList.remove('active');">Libre Franklin</div>
                        <div class="font-dropdown-option font-merriweather" onclick="this.parentNode.parentNode.querySelector('.font-dropdown-current').textContent = 'Merriweather Sans Light'; this.parentNode.parentNode.querySelector('.font-dropdown-current').className = 'font-dropdown-current font-merriweather'; document.body.className = document.body.className.replace(/font-\w+/g, '') + ' font-merriweather'; saveFontChoice('font-merriweather'); this.parentNode.parentNode.classList.remove('active');">Merriweather Sans Light</div>
                        <div class="font-dropdown-option font-avenir" onclick="this.parentNode.parentNode.querySelector('.font-dropdown-current').textContent = 'Mulish'; this.parentNode.parentNode.querySelector('.font-dropdown-current').className = 'font-dropdown-current font-avenir'; document.body.className = document.body.className.replace(/font-\w+/g, '') + ' font-avenir'; saveFontChoice('font-avenir'); this.parentNode.parentNode.classList.remove('active');">Mulish</div>
                        <div class="font-dropdown-option font-sanfrancisco" onclick="this.parentNode.parentNode.querySelector('.font-dropdown-current').textContent = 'Roboto'; this.parentNode.parentNode.querySelector('.font-dropdown-current').className = 'font-dropdown-current font-sanfrancisco'; document.body.className = document.body.className.replace(/font-\w+/g, '') + ' font-sanfrancisco'; saveFontChoice('font-sanfrancisco'); this.parentNode.parentNode.classList.remove('active');">Roboto</div>
                        <div class="font-dropdown-option font-akzidenz" onclick="this.parentNode.parentNode.querySelector('.font-dropdown-current').textContent = 'Work Sans'; this.parentNode.parentNode.querySelector('.font-dropdown-current').className = 'font-dropdown-current font-akzidenz'; document.body.className = document.body.className.replace(/font-\w+/g, '') + ' font-akzidenz'; saveFontChoice('font-akzidenz'); this.parentNode.parentNode.classList.remove('active');">Work Sans</div>
                    </div>
                </div>
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="advancedView" onchange="if(typeof window.dragDropSystem !== 'undefined') window.dragDropSystem.updateStateAndRender()">
                <label for="advancedView">separate user tags / ai tags</label>
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="verticalLayout" onchange="if(typeof window.dragDropSystem !== 'undefined') window.dragDropSystem.updateStateAndRender()">
                <label for="verticalLayout">stack tags vertically</label>
            </div>
        </div>
    </div>

    <!-- Row 3: Main Content (All 3 Columns) -->
    <div class="left-control collapsible-col col-1" style="position: relative;">
        <!-- Control areas are DROP TARGETS for zones -->
        <div class="control-area-container zone-container"
             ondragover="if(event.dataTransfer.types.includes('text/zone')) { event.preventDefault(); this.classList.add('zone-drag-over'); }"
             ondragleave="this.classList.remove('zone-drag-over')"
             ondrop="handleZoneDrop(event, this)">
            <!-- Drop zones are DRAGGABLE ONLY - NO drop handlers -->
            <div class="drop-zone row-zone"
                 id="rows"
                 data-zone-type="row"
                 data-accepts="tags,group-tags"
                 draggable="true"
                 ondragstart="event.dataTransfer.setData('text/zone', 'row')">
                <div class="zone-drag-handle" title="Drag to move zone">
                    <span class="drag-grip">⋮⋮</span>
                </div>
                <span class="zone-label">rows</span>
                <div class="zone-drag-handle zone-drag-handle-right" title="Drag to move zone">
                    <span class="drag-grip">⋮⋮</span>
                </div>
            </div>
        </div>
    </div>

    <div class="card-display">
        <button class="floating-add-card" id="floatingAddCard" onclick="createNewCard()" title="Create new card">+</button>
        <div class="card-container" id="cardContainer">
            <!-- Cards will be populated by JavaScript based on checkbox state and active filters -->
            <p id="emptyStateMessage">No cards to display</p>
        </div>
    </div>

    <div class="right-control collapsible-col col-3" style="position: relative;">
        <!-- Control areas are DROP TARGETS for zones -->
        <div class="control-area-container zone-container"
             ondragover="if(event.dataTransfer.types.includes('text/zone')) { event.preventDefault(); this.classList.add('zone-drag-over'); }"
             ondragleave="this.classList.remove('zone-drag-over')"
             ondrop="handleZoneDrop(event, this)">
            <!-- Drop zones are DRAGGABLE ONLY - NO drop handlers -->
            <div class="drop-zone column-zone"
                 id="columns"
                 data-zone-type="column"
                 data-accepts="tags,group-tags"
                 draggable="true"
                 ondragstart="event.dataTransfer.setData('text/zone', 'column')">
                <div class="zone-drag-handle" title="Drag to move zone">
                    <span class="drag-grip">⋮⋮</span>
                </div>
                <span class="zone-label">columns</span>
                <div class="zone-drag-handle zone-drag-handle-right" title="Drag to move zone">
                    <span class="drag-grip">⋮⋮</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 4 collapse toggle - positioned outside collapsible area -->
    <button class="collapse-toggle collapse-row4" onclick="toggleRow(4)" title="Toggle Row 4" aria-label="Toggle row 4">
        <svg class="chevron chevron-down" width="16" height="16" viewBox="0 0 16 16">
            <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </button>

    <!-- Column collapse toggles - positioned at outer edges -->
    <button class="collapse-toggle collapse-col1" onclick="toggleColumn(1)" title="Toggle Column 1" aria-label="Toggle column 1">
        <svg class="chevron chevron-left" width="16" height="16" viewBox="0 0 16 16">
            <path d="M10 4L6 8L10 12" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </button>

    <button class="collapse-toggle collapse-col3" onclick="toggleColumn(3)" title="Toggle Column 3" aria-label="Toggle column 3">
        <svg class="chevron chevron-right" width="16" height="16" viewBox="0 0 16 16">
            <path d="M6 4L10 8L6 12" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </button>

    <!-- Row 4: Bottom Area (Middle Column Only) -->
    <div class="bottom-control collapsible-row row-4">
        <!-- Control areas are DROP TARGETS for zones -->
        <div class="control-area-container zone-container"
             ondragover="if(event.dataTransfer.types.includes('text/zone')) { event.preventDefault(); this.classList.add('zone-drag-over'); }"
             ondragleave="this.classList.remove('zone-drag-over')"
             ondrop="handleZoneDrop(event, this)">
            <p>drag a drop zone here</p>
            <div class="zone-configuration">
                <!-- Drop zones can be moved here -->
            </div>
        </div>
    </div>
</div>

<script>
function handleZoneDrop(event, container) {
    if(event.dataTransfer.types.includes('text/zone')) {
        event.preventDefault();
        container.classList.remove('zone-drag-over');

        const zoneType = event.dataTransfer.getData('text/zone');
        let draggedZone;

        if(zoneType === 'filter') {
            draggedZone = document.querySelector('.filter-zone-container[data-zone-type="filter"]');
        } else {
            draggedZone = document.querySelector('.' + zoneType + '-zone');
        }

        if(draggedZone && !container.contains(draggedZone)) {
            container.appendChild(draggedZone);
        }
    }
}

function toggleRow(rowNum) {
    const grid = document.getElementById('spatialGrid');
    const rowElements = document.querySelectorAll('.row-' + rowNum);

    // Get all toggles for this row
    let toggles;
    if (rowNum === 1) {
        toggles = document.querySelectorAll('.collapse-row1');
    } else if (rowNum === 2) {
        toggles = document.querySelectorAll('.collapse-row2');
    } else if (rowNum === 4) {
        toggles = document.querySelectorAll('.collapse-row4');
    }

    rowElements.forEach(elem => {
        elem.classList.toggle('collapsed');
    });

    const isCollapsed = rowElements[0] && rowElements[0].classList.contains('collapsed');

    if (isCollapsed) {
        grid.classList.add('row-' + rowNum + '-collapsed');
        // Add collapsed state class for CSS animation
        toggles.forEach(toggle => {
            toggle.classList.add('is-collapsed');
        });
    } else {
        grid.classList.remove('row-' + rowNum + '-collapsed');
        // Remove collapsed state class for CSS animation
        toggles.forEach(toggle => {
            toggle.classList.remove('is-collapsed');
        });
    }
}

function toggleColumn(colNum) {
    const grid = document.getElementById('spatialGrid');
    const colElements = document.querySelectorAll('.col-' + colNum);
    const toggle = document.querySelector('.collapse-col' + colNum);
    const chevron = toggle.querySelector('.chevron');

    colElements.forEach(elem => {
        elem.classList.toggle('collapsed');
    });

    if (colElements[0].classList.contains('collapsed')) {
        grid.classList.add('col-' + colNum + '-collapsed');
        toggle.classList.add('is-collapsed');
    } else {
        grid.classList.remove('col-' + colNum + '-collapsed');
        toggle.classList.remove('is-collapsed');
    }
}
function toggleSection(section) {
    let sectionElement;
    let toggleButton;

    if (section === 'universal') {
        sectionElement = document.querySelector('.universal-control');
        toggleButton = document.querySelector('.collapse-universal');
    } else if (section === 'ui') {
        sectionElement = document.querySelector('.ui-control');
        toggleButton = document.querySelector('.collapse-ui');
    }

    if (sectionElement && toggleButton) {
        sectionElement.classList.toggle('collapsed-section');
        const chevron = toggleButton.querySelector('.chevron');

        if (sectionElement.classList.contains('collapsed-section')) {
            toggleButton.classList.add('is-collapsed');
            chevron.querySelector('path').setAttribute('d', 'M4 10L8 6L12 10');
        } else {
            toggleButton.classList.remove('is-collapsed');
            chevron.querySelector('path').setAttribute('d', 'M4 6L8 10L12 6');
        }
    }
}

function switchLesson(lessonValue) {
    console.log('Switching to lesson:', lessonValue);

    // Send lesson switch request to backend
    fetch('/api/v2/lessons/switch', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            lessonId: lessonValue
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            console.log('Lesson switched successfully:', data.lesson_state);

            // Store lesson state in localStorage for persistence
            localStorage.setItem('currentLesson', lessonValue);
            window.currentLessonState = data.lesson_state;

            // Clear all zones and reset state when switching lessons
            if (typeof window.dragDropSystem !== 'undefined') {
                window.dragDropSystem.clearAllZones();
            }

            // Reload the page with lesson parameter to load the new lesson's tags and cards
            console.log('Reloading page for lesson', lessonValue);
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('lesson', lessonValue);
            window.location.href = currentUrl.toString();

        } else {
            console.error('Failed to switch lesson:', data);
        }
    })
    .catch(error => {
        console.error('Error switching lesson:', error);
    });
}

// Placeholder for database switching function (if not already implemented)
function switchDatabase(databaseValue) {
    console.log('Switching to database:', databaseValue);
    // TODO: Implement database switching logic
}

// Handle tag creation from input
async function createTag(tagName, cloudType = 'user') {
    try {
        const response = await fetch('/api/v2/tags/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: tagName })
        });

        if (response.ok) {
            const data = await response.json();
            // Add tag to DOM with UUID
            const cloud = document.querySelector(`.cloud-${cloudType} .tags-wrapper`);
            if (cloud) {
                const tagElement = document.createElement('span');
                tagElement.className = `tag tag-${cloudType}`;
                tagElement.setAttribute('data-tag', tagName);
                tagElement.setAttribute('data-tag-id', data.tag_id);  // Store UUID
                tagElement.setAttribute('data-type', 'tag');
                tagElement.setAttribute('draggable', 'true');
                tagElement.id = `tag-${tagName}`;
                tagElement.innerHTML = `${tagName} (0) <button class="tag-delete" onclick="deleteTag('${data.tag_id}', this)" title="Delete tag">×</button>`;
                cloud.appendChild(tagElement);
            }
            return data;
        }
    } catch (error) {
        console.error('Failed to create tag:', error);
    }
}

// Create new card with tags from SHOW and FILTER zones
async function createNewCard() {
    // Get tag UUIDs and names from SHOW and FILTER zones
    const unionTags = Array.from(document.querySelectorAll('[data-zone-type="union"] .tag'));
    const intersectionTags = Array.from(document.querySelectorAll('[data-zone-type="intersection"] .tag'));
    const allTags = [...new Set([...unionTags, ...intersectionTags])];

    const tagIds = allTags.map(t => t.getAttribute('data-tag-id')).filter(Boolean);
    const tagNames = allTags.map(t => t.getAttribute('data-tag')).filter(Boolean);

    // Generate UUID for new card
    const cardId = crypto.randomUUID();

    // Create card element in DOM
    const cardContainer = document.querySelector('.card-container');
    const cardElement = document.createElement('div');
    cardElement.className = 'card-item';
    cardElement.setAttribute('data-card-id', cardId);

    cardElement.innerHTML = `
        <div class="card-content">
            <button class="card-delete" onclick="deleteCard('${cardId}', this)" title="Delete card">×</button>
            <div class="card-header">
                <h4 class="card-title" contenteditable="true" style="outline: 2px solid #3b82f6;"></h4>
            </div>
            <div class="card-footer">
                <div class="card-tags-section">
                    <div class="card-tags-header">
                        <span class="card-tags-label">tags (${tagNames.length})</span>
                    </div>
                    <div class="card-tags">
                        ${tagNames.map((name, i) =>
                            `<span class="card-tag" data-tag="${name}" data-tag-id="${tagIds[i]}">${name} <span class="tag-remove" onclick="removeTagFromCard('${cardId}', '${tagIds[i]}', this)">×</span></span>`
                        ).join('')}
                    </div>
                </div>
            </div>
        </div>
    `;

    cardContainer.appendChild(cardElement);

    // Focus on title for editing
    const titleElement = cardElement.querySelector('.card-title');
    titleElement.focus();

    // Save to database when user presses Enter or loses focus
    const saveCard = async () => {
        const name = titleElement.textContent.trim();
        if (!name) {
            cardElement.remove();
            return;
        }

        titleElement.setAttribute('contenteditable', 'false');
        titleElement.style.outline = 'none';

        try {
            const response = await fetch('/api/v2/cards/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, tag_ids: tagIds })
            });

            if (response.ok) {
                console.log('Card saved to database');
            } else {
                const error = await response.json();
                console.error('Failed to save card:', error);
                alert('Failed to save card: ' + (error.message || 'Unknown error'));
            }
        } catch (error) {
            console.error('Failed to save card:', error);
            alert('Failed to save card');
        }
    };

    titleElement.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            saveCard();
        }
    });

    titleElement.addEventListener('blur', saveCard);
}

// Remove tag from card (using UUID)
async function removeTagFromCard(cardId, tagId, removeButton) {
    try {
        const response = await fetch('/api/v2/cards/remove-tag', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ card_id: cardId, tag_id: tagId })
        });

        if (response.ok) {
            // Remove tag representation from DOM
            const tagRep = removeButton.closest('.card-tag');
            const tagName = tagRep?.getAttribute('data-tag');
            if (tagRep) tagRep.remove();

            // Update tag count (trigger handles this automatically now)
            if (tagName) {
                const originalTag = document.getElementById(`tag-${tagName}`);
                if (originalTag) {
                    const match = originalTag.textContent.match(/\((\d+)\)/);
                    const currentCount = match ? parseInt(match[1]) : 0;
                    originalTag.textContent = `${tagName} (${Math.max(0, currentCount - 1)})`;
                }
            }
        }
    } catch (error) {
        console.error('Failed to remove tag from card:', error);
    }
}

// Delete card
async function deleteCard(cardId, deleteButton) {
    if (!confirm('Delete this card?')) return;

    try {
        const response = await fetch('/api/v2/cards/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ card_id: cardId })
        });

        if (response.ok) {
            const cardElement = deleteButton.closest('.card-item');
            if (cardElement) cardElement.remove();
        } else {
            alert('Failed to delete card');
        }
    } catch (error) {
        console.error('Failed to delete card:', error);
        alert('Failed to delete card');
    }
}

// Delete tag
async function deleteTag(tagId, deleteButton) {
    if (!confirm('Delete this tag?')) return;

    try {
        const response = await fetch('/api/v2/tags/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tag_id: tagId })
        });

        if (response.ok) {
            const tagElement = deleteButton.closest('.tag');
            if (tagElement) tagElement.remove();
        } else {
            alert('Failed to delete tag');
        }
    } catch (error) {
        console.error('Failed to delete tag:', error);
        alert('Failed to delete tag');
    }
}

// Make card title editable
function makeCardTitleEditable(cardElement) {
    const titleElement = cardElement.querySelector('.card-title');
    if (!titleElement || titleElement.querySelector('input')) return;

    const currentTitle = titleElement.textContent;
    const input = document.createElement('input');
    input.type = 'text';
    input.value = currentTitle;
    input.className = 'card-title-input';
    input.style.width = '100%';
    input.style.font = 'inherit';
    input.style.border = '1px solid #ccc';
    input.style.padding = '2px';

    titleElement.textContent = '';
    titleElement.appendChild(input);
    input.focus();
    input.select();

    const saveTitle = async () => {
        const newTitle = input.value.trim();
        if (newTitle && newTitle !== currentTitle) {
            const cardId = cardElement.getAttribute('data-card-id');
            try {
                const response = await fetch('/api/v2/cards/update-title', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ card_id: cardId, title: newTitle })
                });
                if (response.ok) {
                    titleElement.textContent = newTitle;
                } else {
                    titleElement.textContent = currentTitle;
                }
            } catch (error) {
                console.error('Failed to update card title:', error);
                titleElement.textContent = currentTitle;
            }
        } else {
            titleElement.textContent = currentTitle;
        }
        input.blur();
    };

    input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            saveTitle();
        }
    });

    input.addEventListener('blur', saveTitle);
}

// Initialize cards on page load - always trigger initial render for lesson mode
document.addEventListener('DOMContentLoaded', function() {
    // Setup tag input handlers
    document.querySelectorAll('.tag-input').forEach(input => {
        input.addEventListener('keypress', async function(e) {
            if (e.key === 'Enter' && this.value.trim()) {
                const tagName = this.value.trim();
                const cloudType = this.closest('.cloud-user') ? 'user' :
                                 this.closest('.cloud-ai') ? 'ai' : 'user';
                await createTag(tagName, cloudType);
                this.value = '';
            }
        });
    });

    // Setup card title editing
    document.addEventListener('click', (e) => {
        if (e.target.closest('.card-title') && !e.target.closest('input')) {
            const card = e.target.closest('.card-item');
            if (card) makeCardTitleEditable(card);
        }
    });

    document.addEventListener('keypress', (e) => {
        if (e.key === 't' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
            const hoveredCard = document.elementFromPoint(e.clientX || 0, e.clientY || 0)?.closest('.card-item');
            if (hoveredCard) {
                e.preventDefault();
                makeCardTitleEditable(hoveredCard);
            }
        }
    });

    // Setup card tag drop zones
    document.addEventListener('dragover', (e) => {
        const cardTags = e.target.closest('.card-tags');
        if (cardTags) {
            e.preventDefault();
            cardTags.classList.add('drag-over');
        }
    });

    document.addEventListener('dragleave', (e) => {
        const cardTags = e.target.closest('.card-tags');
        if (cardTags && !cardTags.contains(e.relatedTarget)) {
            cardTags.classList.remove('drag-over');
        }
    });

    document.addEventListener('drop', async (e) => {
        const cardTags = e.target.closest('.card-tags');
        if (cardTags) {
            e.preventDefault();
            e.stopPropagation();
            cardTags.classList.remove('drag-over');

            const card = cardTags.closest('.card-item');
            const cardId = card?.getAttribute('data-card-id');
            if (!cardId) return;

            // Get dragged tag name from dragDropSystem
            const draggedElements = window.dragDropSystem?.draggedElements || [];
            if (draggedElements.length === 0) return;

            for (const tagElement of draggedElements) {
                const tagName = tagElement.getAttribute('data-tag');
                const tagId = tagElement.getAttribute('data-tag-id');
                if (!tagName || !tagId) continue;

                // Check if tag already on card
                if (cardTags.querySelector(`[data-tag="${tagName}"]`)) continue;

                // Add tag to card in database using UUID
                try {
                    console.log('Adding tag to card:', { card_id: cardId, tag_id: tagId });
                    const response = await fetch('/api/v2/cards/add-tag', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ card_id: cardId, tag_id: tagId })
                    });

                    const result = await response.json();
                    console.log('Add tag response:', result);

                    if (response.ok && result.success) {
                        // Add tag representation to DOM
                        const tagRep = document.createElement('span');
                        tagRep.className = 'card-tag';
                        tagRep.setAttribute('data-tag', tagName);
                        tagRep.setAttribute('data-tag-id', tagId);
                        tagRep.innerHTML = `${tagName} <span class="tag-remove" onclick="removeTagFromCard('${cardId}', '${tagId}', this)">×</span>`;
                        cardTags.appendChild(tagRep);

                        // Update tag count (trigger handles this automatically now)
                        const originalTag = document.getElementById(`tag-${tagName}`);
                        if (originalTag) {
                            const match = originalTag.textContent.match(/\((\d+)\)/);
                            const currentCount = match ? parseInt(match[1]) : 0;
                            originalTag.textContent = `${tagName} (${currentCount + 1})`;
                        }
                    } else {
                        console.error('Failed to add tag:', result.message);
                    }
                } catch (error) {
                    console.error('Failed to add tag to card:', error);
                }
            }
        }
    });

    // Wait a moment for drag-drop system to initialize
    setTimeout(function() {
        console.log('Initializing cards on page load for lesson mode...');
        if (typeof window.dragDropSystem !== 'undefined') {
            window.dragDropSystem.updateStateAndRender();
        } else {
            console.log('dragDropSystem not yet available, will try again...');
            // Try again after another delay
            setTimeout(function() {
                if (typeof window.dragDropSystem !== 'undefined') {
                    window.dragDropSystem.updateStateAndRender();
                } else {
                    console.log('dragDropSystem still not available, trying once more...');
                    setTimeout(function() {
                        if (typeof window.dragDropSystem !== 'undefined') {
                            window.dragDropSystem.updateStateAndRender();
                        }
                    }, 2000);
                }
            }, 1000);
        }
    }, 500);
});
</script>

{% endblock %}
