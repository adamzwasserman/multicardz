{% extends "base.html" %}

{% block content %}
<div class="spatial-grid row-4-collapsed" id="spatialGrid"
     {% if workspace_id %}data-workspace="{{ workspace_id }}"{% endif %}
     {% if user_id %}data-user="{{ user_id }}"{% endif %}
     style="grid-template-columns: {{ left_width }}px 1fr {{ right_width }}px;">
    <!-- Row 1: Tag Management (Middle Column Only) -->
    <button class="collapse-toggle collapse-row1" onclick="toggleRow(1)" title="Toggle Row 1" aria-label="Toggle row 1">
        <svg class="chevron chevron-up" width="16" height="16" viewBox="0 0 16 16">
            <path d="M4 10L8 6L12 10" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </button>
    <div class="debug-group collapsible-row row-1" style="position: relative; display: none;">
        <label for="tagsInPlay">tags in play</label>
        <textarea class="tags-in-play" id="tagsInPlay" placeholder="waiting for zone activity..." aria-label="Tags in play" readonly rows="8">{"union":[],"intersection":[],"exclusion":[],"row":[],"column":[]}</textarea>
    </div>
    <div class="tag-management collapsible-row row-1" style="position: relative;">
        <div class="clouds-container horizontal" id="cloudsContainer" data-zone-type="tag-cloud" data-accepts="tags,group-tags">
            <!-- User Tags Cloud -->
            <div class="cloud cloud-user"
                 data-cloud-type="user"
>
                <div class="cloud-title cloud-title-user">
                    user tags<span class="tag-count">({{ available_tags|length }})</span>
                </div>
                <div class="tags-wrapper">
                    {% for tag in available_tags %}
                    <span class="tag tag-user"
                          data-tag="{{ tag.name }}"
                          data-tag-id="{{ tag.id }}"
                          data-type="tag"
                          draggable="true"
                          id="tag-{{ tag.name }}"
                          style="--tag-index: {{ loop.index0 }}"
>
                        <span class="tag-color-dot"></span>{{ tag.name }} ({{ tag.count }})
                        <button class="tag-delete" onclick="deleteTag('{{ tag.id }}', this)" title="Delete tag">×</button>
                    </span>
                    {% endfor %}
                </div>
                <div class="input-wrapper">
                    <input type="text" class="tag-input" placeholder="Add user tag..." aria-label="add user tag"
>
                </div>
            </div>

            <!-- Secondary Tag Clouds Container -->
            <div class="clouds-secondary">
                <!-- AI Tags Cloud (Hidden in simple view, shown in advanced view) -->
                <div class="cloud cloud-ai" id="aiTagsCloud" style="display: none;"
                     data-cloud-type="ai"
>
                    <div class="cloud-title cloud-title-ai">
                        ai tags<span class="tag-count">(3)</span>
                    </div>
                    <div class="tags-wrapper">
                        <span class="tag tag-ai"
                              data-tag="machine-learning"
                              data-tag-id="ai-ml"
                              data-type="ai-tag"
                              draggable="true"
>
                            machine-learning
                            <button class="tag-delete" onclick="deleteTag('ai-ml', this)" title="Delete tag">×</button>
                        </span>
                        <span class="tag tag-ai"
                              data-tag="data-processing"
                              data-tag-id="ai-dp"
                              data-type="ai-tag"
                              draggable="true"
>
                            data-processing
                            <button class="tag-delete" onclick="deleteTag('ai-dp', this)" title="Delete tag">×</button>
                        </span>
                        <span class="tag tag-ai"
                              data-tag="automation"
                              data-tag-id="ai-auto"
                              data-type="ai-tag"
                              draggable="true"
>
                            automation
                            <button class="tag-delete" onclick="deleteTag('ai-auto', this)" title="Delete tag">×</button>
                        </span>
                    </div>
                </div>

                <!-- Tag Groups Cloud -->
                <div class="cloud cloud-group">
                    <div class="cloud-title cloud-title-group">
                        tag groups<span class="tag-count">({{ groups|length }})</span>
                    </div>
                    <div class="tags-wrapper">
                        {% for group in groups %}
                        <span class="tag tag-group"
                              data-group="{{ group.id }}"
                              data-type="group-tag"
                              draggable="true"
>
                            {{ group.name }}
                        </span>
                        {% endfor %}
                    </div>
                    <div class="input-wrapper">
                        <input type="text" class="tag-input" placeholder="Add group..." aria-label="Add group"
>
                    </div>
                </div>

                <!-- System Tags Cloud -->
                <div class="cloud cloud-system"
                     data-cloud-type="system">
                    <div class="cloud-title cloud-title-system">
                        system tags<span class="tag-count">(3)</span>
                    </div>
                    <div class="tags-wrapper">
                        <span class="tag tag-system" data-type="system-tag" draggable="true">Priority</span>
                        <span class="tag tag-system" data-type="system-tag" draggable="true">Archive</span>
                        <span class="tag tag-system tag-empty" data-tag="EMPTY" data-type="system-tag" draggable="true">EMPTY (no tags)</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 2: Control Areas (All 3 Columns) -->
    <button class="collapse-toggle collapse-row2" onclick="toggleRow(2)" title="Toggle Row 2" aria-label="Toggle row 2">
        <svg class="chevron chevron-up" width="16" height="16" viewBox="0 0 16 16">
            <path d="M4 10L8 6L12 10" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </button>
    <!-- Global settings section removed - controls moved to settings drawer -->

    <div class="top-control collapsible-row row-2" style="position: relative;">
        <!-- Control areas are DROP TARGETS for zones -->
        <div class="control-area-container zone-container"
             ondragover="if(event.dataTransfer.types.includes('text/zone')) { event.preventDefault(); this.classList.add('zone-drag-over'); }"
             ondragleave="this.classList.remove('zone-drag-over')"
             ondrop="if(event.dataTransfer.types.includes('text/zone')) { handleZoneDrop(event, this); }">
            <!-- Filter zone container - NOT a drop zone, just a visual container -->
            <div class="filter-zone-container"
                 id="filter"
                 data-zone-type="filter"
                 draggable="true"
                 ondragstart="event.dataTransfer.setData('text/zone', 'filter')">
                <div class="zone-drag-handle" title="Drag to move zone">
                    <span class="drag-grip">⋮⋮</span>
                </div>

                <!-- Union Drop Zone (ANY) -->
                <div class="drop-zone filter-subzone union-zone"
                     id="union_tags"
                     data-zone-type="union"
                     data-behavior="union"
                     data-accepts="tags,group-tags"
>
                    <span class="zone-label">SHOW cards with these tags</span>
                    <div class="tag-collection" id="union-tags-container"></div>
                </div>

                <!-- Red Dot Separator -->
                <div class="zone-separator">
                    <div class="separator-dot"></div>
                </div>

                <!-- Intersection Drop Zone (ALL) -->
                <div class="drop-zone filter-subzone intersection-zone"
                     id="intersection_tags"
                     data-zone-type="intersection"
                     data-behavior="intersection"
                     data-accepts="tags,group-tags"
>
                    <span class="zone-label">FILTER cards by these tags</span>
                    <div class="tag-collection" id="intersection-tags-container"></div>
                </div>

                <!-- Red Dot Separator -->
                <div class="zone-separator">
                    <div class="separator-dot separator-dot-red"></div>
                </div>

                <!-- Exclusion Drop Zone (NONE) -->
                <div class="drop-zone filter-subzone exclusion-zone"
                     id="exclusion_tags"
                     data-zone-type="exclusion"
                     data-zone-behavior="exclusion"
                     data-accepts="tags,group-tags"
>
                    <span class="zone-label">HIDE cards with these tags</span>
                    <div class="tag-collection" id="exclusion-tags-container"></div>
                </div>

                <div class="zone-drag-handle zone-drag-handle-right" title="Drag to move zone">
                    <span class="drag-grip">⋮⋮</span>
                </div>
            </div>
        </div>
    </div>

    <!-- User interface section removed - controls moved to settings drawer -->

    <!-- Row 3: Main Content (All 3 Columns) -->
    <div class="left-control collapsible-col col-1" style="position: relative;">
        <!-- Control areas are DROP TARGETS for zones -->
        <div class="control-area-container zone-container"
             ondragover="if(event.dataTransfer.types.includes('text/zone')) { event.preventDefault(); this.classList.add('zone-drag-over'); }"
             ondragleave="this.classList.remove('zone-drag-over')"
             ondrop="if(event.dataTransfer.types.includes('text/zone')) { handleZoneDrop(event, this); }">
            <!-- Drop zones accept both tags and can be dragged to move -->
            <!-- Default layout: column first, then row -->
            <div class="drop-zone column-zone"
                 id="columns"
                 data-zone-type="column"
                 data-accepts="tags,group-tags"
                 draggable="true"
                 ondragstart="event.dataTransfer.setData('text/zone', 'column')">
                <div class="zone-drag-handle" title="Drag to move zone">
                    <span class="drag-grip">⋮⋮</span>
                </div>
                <span class="zone-label">columns</span>
                <div class="tag-collection" id="column-tags-container"></div>
                <div class="zone-drag-handle zone-drag-handle-right" title="Drag to move zone">
                    <span class="drag-grip">⋮⋮</span>
                </div>
            </div>
            <div class="drop-zone row-zone"
                 id="rows"
                 data-zone-type="row"
                 data-accepts="tags,group-tags"
                 draggable="true"
                 ondragstart="event.dataTransfer.setData('text/zone', 'row')">
                <div class="zone-drag-handle" title="Drag to move zone">
                    <span class="drag-grip">⋮⋮</span>
                </div>
                <span class="zone-label">rows</span>
                <div class="tag-collection" id="row-tags-container"></div>
                <div class="zone-drag-handle zone-drag-handle-right" title="Drag to move zone">
                    <span class="drag-grip">⋮⋮</span>
                </div>
            </div>
        </div>
    </div>

    <div class="card-display">
        <div class="card-container" id="cardContainer">
            <!-- Cards will be populated by JavaScript - starts empty to avoid layout shift -->
        </div>
    </div>

    <div class="right-control collapsible-col col-3" style="position: relative;">
        <!-- Control areas are DROP TARGETS for zones -->
        <div class="control-area-container zone-container"
             ondragover="if(event.dataTransfer.types.includes('text/zone')) { event.preventDefault(); this.classList.add('zone-drag-over'); }"
             ondragleave="this.classList.remove('zone-drag-over')"
             ondrop="if(event.dataTransfer.types.includes('text/zone')) { handleZoneDrop(event, this); }">
            <!-- Right control area - empty by default -->
        </div>
    </div>

    <!-- Row 4 collapse toggle - positioned outside collapsible area -->
    <button class="collapse-toggle collapse-row4 is-collapsed" onclick="toggleRow(4)" title="Toggle Row 4" aria-label="Toggle row 4">
        <svg class="chevron chevron-down" width="16" height="16" viewBox="0 0 16 16">
            <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </button>


    <!-- Row 4: Bottom Area (Middle Column Only) -->
    <div class="bottom-control collapsible-row row-4 collapsed">
        <!-- Control areas are DROP TARGETS for zones -->
        <div class="control-area-container zone-container"
             ondragover="if(event.dataTransfer.types.includes('text/zone')) { event.preventDefault(); this.classList.add('zone-drag-over'); }"
             ondragleave="this.classList.remove('zone-drag-over')"
             ondrop="if(event.dataTransfer.types.includes('text/zone')) { handleZoneDrop(event, this); }">
            <p>drag a drop zone here</p>
            <div class="zone-configuration">
                <!-- Drop zones can be moved here -->
            </div>
        </div>
    </div>
</div>

<!-- Application logic loaded from /static/js/app.js -->

{% endblock %}
