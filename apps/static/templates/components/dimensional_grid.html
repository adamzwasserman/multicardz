<!-- Dimensional Grid Component -->
<div class="dimensional-grid-container">
    {% if column_tags and row_tags %}
        <!-- 2D Grid: Both rows and columns -->
        <div class="dimensional-grid two-dimensional {% if show_expanded %}cards-expanded{% endif %} {% if show_colors %}show-colors{% endif %}" style="--col-count: {{ column_tags|length + 1 }}" data-palette="{{ color_palette|default('muji') }}">
            <!-- Header row with column labels -->
            <div class="grid-header">
                <div class="grid-corner"></div>
                {% for col_tag in column_tags %}
                <div class="grid-col-header">{{ col_tag }}</div>
                {% endfor %}
                <div class="grid-col-header grid-col-header-other">other</div>
            </div>

            <!-- Data rows -->
            {% for row_tag in row_tags %}
            <div class="grid-row">
                <div class="grid-row-header">{{ row_tag }}</div>
                {% for col_tag in column_tags %}
                <div class="grid-cell" data-row="{{ row_tag }}" data-col="{{ col_tag }}">
                    {% set cell_cards = [] %}
                    {% for card in cards %}
                        {% if row_tag in card.tags and col_tag in card.tags %}
                            {% set _ = cell_cards.append(card) %}
                        {% endif %}
                    {% endfor %}

                    {% if cell_cards %}
                        {% for card in cell_cards %}
                        <div class="card-item" data-card-id="{{ card.id }}">
                            <div class="card-content">
                                <button class="card-delete" onclick="deleteCard('{{ card.id }}', this)" title="Delete card">×</button>
                                <div class="card-header">
                                    <h4 class="card-title" contenteditable="true" data-card-id="{{ card.id }}" onblur="updateCardTitle(this)">{{ card.title }}</h4>
                                </div>
                                <div class="card-footer">
                                    <div class="card-tags-section">
                                        <div class="card-tags-header">
                                            <span class="card-tags-label">tags ({{ card.tags|length }})</span>
                                        </div>
                                        <div class="card-tags">
                                            {% for tag in card.tags %}
                                            <span class="card-tag" data-tag="{{ tag }}" style="--tag-index: {{ tag_order.index(tag) if tag in tag_order else 0 }}"><span class="tag-color-dot"></span>{{ tag }} <span class="tag-remove" onclick="removeTagFromCard('{{ card.id }}', '{{ tag }}', this)">×</span></span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-cell">∅</div>
                    {% endif %}
                    <button class="grid-cell-add-button" onclick="createNewCard('{{ row_tag }}', '{{ col_tag }}')" title="Add card to this cell">+</button>
                </div>
                {% endfor %}

                <!-- Other column: cards with row tag AND no column tags (complement of all column sets) -->
                <div class="grid-cell grid-cell-other" data-row="{{ row_tag }}" data-col="other">
                    {% set other_cards = [] %}
                    {% for card in cards %}
                        {# Card must have the row tag AND none of the column tags #}
                        {% if row_tag in card.tags and not (column_tags | select('in', card.tags) | list) %}
                            {% set _ = other_cards.append(card) %}
                        {% endif %}
                    {% endfor %}

                    {% if other_cards %}
                        {% for card in other_cards %}
                        <div class="card-item" data-card-id="{{ card.id }}">
                            <div class="card-content">
                                <button class="card-delete" onclick="deleteCard('{{ card.id }}', this)" title="Delete card">×</button>
                                <div class="card-header">
                                    <h4 class="card-title" contenteditable="true" data-card-id="{{ card.id }}" onblur="updateCardTitle(this)">{{ card.title }}</h4>
                                </div>
                                <div class="card-footer">
                                    <div class="card-tags-section">
                                        <div class="card-tags-header">
                                            <span class="card-tags-label">tags ({{ card.tags|length }})</span>
                                        </div>
                                        <div class="card-tags">
                                            {% for tag in card.tags %}
                                            <span class="card-tag" data-tag="{{ tag }}" style="--tag-index: {{ tag_order.index(tag) if tag in tag_order else 0 }}"><span class="tag-color-dot"></span>{{ tag }} <span class="tag-remove" onclick="removeTagFromCard('{{ card.id }}', '{{ tag }}', this)">×</span></span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-cell">∅</div>
                    {% endif %}
                    <button class="grid-cell-add-button" onclick="createNewCard('{{ row_tag }}', 'other')" title="Add card to this cell">+</button>
                </div>
            </div>
            {% endfor %}

            <!-- Other row: cards with column tag AND no row tags (complement of all row sets) -->
            <div class="grid-row">
                <div class="grid-row-header grid-row-header-other">other</div>
                {% for col_tag in column_tags %}
                <div class="grid-cell grid-cell-other" data-row="other" data-col="{{ col_tag }}">
                    {% set other_cards = [] %}
                    {% for card in cards %}
                        {# Card must have the column tag AND none of the row tags #}
                        {% if col_tag in card.tags and not (row_tags | select('in', card.tags) | list) %}
                            {% set _ = other_cards.append(card) %}
                        {% endif %}
                    {% endfor %}

                    {% if other_cards %}
                        {% for card in other_cards %}
                        <div class="card-item" data-card-id="{{ card.id }}">
                            <div class="card-content">
                                <button class="card-delete" onclick="deleteCard('{{ card.id }}', this)" title="Delete card">×</button>
                                <div class="card-header">
                                    <h4 class="card-title" contenteditable="true" data-card-id="{{ card.id }}" onblur="updateCardTitle(this)">{{ card.title }}</h4>
                                </div>
                                <div class="card-footer">
                                    <div class="card-tags-section">
                                        <div class="card-tags-header">
                                            <span class="card-tags-label">tags ({{ card.tags|length }})</span>
                                        </div>
                                        <div class="card-tags">
                                            {% for tag in card.tags %}
                                            <span class="card-tag" data-tag="{{ tag }}" style="--tag-index: {{ tag_order.index(tag) if tag in tag_order else 0 }}"><span class="tag-color-dot"></span>{{ tag }} <span class="tag-remove" onclick="removeTagFromCard('{{ card.id }}', '{{ tag }}', this)">×</span></span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-cell">∅</div>
                    {% endif %}
                    <button class="grid-cell-add-button" onclick="createNewCard('other', '{{ col_tag }}')" title="Add card to this cell">+</button>
                </div>
                {% endfor %}

                <!-- Other-other cell: complement of all row AND column sets -->
                <div class="grid-cell grid-cell-other" data-row="other" data-col="other">
                    {% set other_other_cards = [] %}
                    {% for card in cards %}
                        {# Card must have NONE of the row tags AND NONE of the column tags #}
                        {% if not (row_tags | select('in', card.tags) | list) and not (column_tags | select('in', card.tags) | list) %}
                            {% set _ = other_other_cards.append(card) %}
                        {% endif %}
                    {% endfor %}

                    {% if other_other_cards %}
                        {% for card in other_other_cards %}
                        <div class="card-item" data-card-id="{{ card.id }}">
                            <div class="card-content">
                                <button class="card-delete" onclick="deleteCard('{{ card.id }}', this)" title="Delete card">×</button>
                                <div class="card-header">
                                    <h4 class="card-title" contenteditable="true" data-card-id="{{ card.id }}" onblur="updateCardTitle(this)">{{ card.title }}</h4>
                                </div>
                                <div class="card-footer">
                                    <div class="card-tags-section">
                                        <div class="card-tags-header">
                                            <span class="card-tags-label">tags ({{ card.tags|length }})</span>
                                        </div>
                                        <div class="card-tags">
                                            {% for tag in card.tags %}
                                            <span class="card-tag" data-tag="{{ tag }}" style="--tag-index: {{ tag_order.index(tag) if tag in tag_order else 0 }}"><span class="tag-color-dot"></span>{{ tag }} <span class="tag-remove" onclick="removeTagFromCard('{{ card.id }}', '{{ tag }}', this)">×</span></span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-cell">∅</div>
                    {% endif %}
                    <button class="grid-cell-add-button" onclick="createNewCard('other', 'other')" title="Add card to this cell">+</button>
                </div>
            </div>
        </div>

    {% elif column_tags %}
        <!-- 1D Grid: Columns only (horizontal) -->
        <div class="dimensional-grid columns-only {% if show_expanded %}cards-expanded{% endif %} {% if show_colors %}show-colors{% endif %}" data-palette="{{ color_palette|default('muji') }}">
            <div class="grid-header">
                {% for col_tag in column_tags %}
                <div class="grid-col-header">{{ col_tag }}</div>
                {% endfor %}
                <div class="grid-col-header grid-col-header-other">other</div>
            </div>
            <div class="grid-row">
                {% for col_tag in column_tags %}
                <div class="grid-cell" data-col="{{ col_tag }}">
                    {% set col_cards = [] %}
                    {% for card in cards %}
                        {% if col_tag in card.tags %}
                            {% set _ = col_cards.append(card) %}
                        {% endif %}
                    {% endfor %}

                    {% if col_cards %}
                        {% for card in col_cards %}
                        <div class="card-item" data-card-id="{{ card.id }}">
                            <div class="card-content">
                                <button class="card-delete" onclick="deleteCard('{{ card.id }}', this)" title="Delete card">×</button>
                                <div class="card-header">
                                    <h4 class="card-title" contenteditable="true" data-card-id="{{ card.id }}" onblur="updateCardTitle(this)">{{ card.title }}</h4>
                                </div>
                                <div class="card-footer">
                                    <div class="card-tags-section">
                                        <div class="card-tags-header">
                                            <span class="card-tags-label">tags ({{ card.tags|length }})</span>
                                        </div>
                                        <div class="card-tags">
                                            {% for tag in card.tags %}
                                            <span class="card-tag" data-tag="{{ tag }}" style="--tag-index: {{ tag_order.index(tag) if tag in tag_order else 0 }}"><span class="tag-color-dot"></span>{{ tag }} <span class="tag-remove" onclick="removeTagFromCard('{{ card.id }}', '{{ tag }}', this)">×</span></span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-cell">∅</div>
                    {% endif %}
                    <button class="grid-cell-add-button" onclick="createNewCard(null, '{{ col_tag }}')" title="Add card to this cell">+</button>
                </div>
                {% endfor %}

                <!-- Other column: complement of all column sets (cards with NONE of the column tags) -->
                <div class="grid-cell grid-cell-other" data-col="other">
                    {% set other_cards = [] %}
                    {% for card in cards %}
                        {% if not (column_tags | select('in', card.tags) | list) %}
                            {% set _ = other_cards.append(card) %}
                        {% endif %}
                    {% endfor %}

                    {% if other_cards %}
                        {% for card in other_cards %}
                        <div class="card-item" data-card-id="{{ card.id }}">
                            <div class="card-content">
                                <button class="card-delete" onclick="deleteCard('{{ card.id }}', this)" title="Delete card">×</button>
                                <div class="card-header">
                                    <h4 class="card-title" contenteditable="true" data-card-id="{{ card.id }}" onblur="updateCardTitle(this)">{{ card.title }}</h4>
                                </div>
                                <div class="card-footer">
                                    <div class="card-tags-section">
                                        <div class="card-tags-header">
                                            <span class="card-tags-label">tags ({{ card.tags|length }})</span>
                                        </div>
                                        <div class="card-tags">
                                            {% for tag in card.tags %}
                                            <span class="card-tag" data-tag="{{ tag }}" style="--tag-index: {{ tag_order.index(tag) if tag in tag_order else 0 }}"><span class="tag-color-dot"></span>{{ tag }} <span class="tag-remove" onclick="removeTagFromCard('{{ card.id }}', '{{ tag }}', this)">×</span></span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-cell">∅</div>
                    {% endif %}
                    <button class="grid-cell-add-button" onclick="createNewCard(null, 'other')" title="Add card to this cell">+</button>
                </div>
            </div>
        </div>

    {% elif row_tags %}
        <!-- 1D Grid: Rows only (vertical) -->
        <div class="dimensional-grid rows-only {% if show_expanded %}cards-expanded{% endif %} {% if show_colors %}show-colors{% endif %}" data-palette="{{ color_palette|default('muji') }}">
            {% for row_tag in row_tags %}
            <div class="grid-row">
                <div class="grid-row-header">{{ row_tag }}</div>
                <div class="grid-cell" data-row="{{ row_tag }}">
                    {% set row_cards = [] %}
                    {% for card in cards %}
                        {% if row_tag in card.tags %}
                            {% set _ = row_cards.append(card) %}
                        {% endif %}
                    {% endfor %}

                    {% if row_cards %}
                        {% for card in row_cards %}
                        <div class="card-item" data-card-id="{{ card.id }}">
                            <div class="card-content">
                                <button class="card-delete" onclick="deleteCard('{{ card.id }}', this)" title="Delete card">×</button>
                                <div class="card-header">
                                    <h4 class="card-title" contenteditable="true" data-card-id="{{ card.id }}" onblur="updateCardTitle(this)">{{ card.title }}</h4>
                                </div>
                                <div class="card-footer">
                                    <div class="card-tags-section">
                                        <div class="card-tags-header">
                                            <span class="card-tags-label">tags ({{ card.tags|length }})</span>
                                        </div>
                                        <div class="card-tags">
                                            {% for tag in card.tags %}
                                            <span class="card-tag" data-tag="{{ tag }}" style="--tag-index: {{ tag_order.index(tag) if tag in tag_order else 0 }}"><span class="tag-color-dot"></span>{{ tag }} <span class="tag-remove" onclick="removeTagFromCard('{{ card.id }}', '{{ tag }}', this)">×</span></span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-cell">∅</div>
                    {% endif %}
                    <button class="grid-cell-add-button" onclick="createNewCard('{{ row_tag }}', null)" title="Add card to this cell">+</button>
                </div>
            </div>
            {% endfor %}

            <!-- Other row: complement of all row sets (cards with NONE of the row tags) -->
            <div class="grid-row">
                <div class="grid-row-header grid-row-header-other">other</div>
                <div class="grid-cell grid-cell-other" data-row="other">
                    {% set other_cards = [] %}
                    {% for card in cards %}
                        {% if not (row_tags | select('in', card.tags) | list) %}
                            {% set _ = other_cards.append(card) %}
                        {% endif %}
                    {% endfor %}

                    {% if other_cards %}
                        {% for card in other_cards %}
                        <div class="card-item" data-card-id="{{ card.id }}">
                            <div class="card-content">
                                <button class="card-delete" onclick="deleteCard('{{ card.id }}', this)" title="Delete card">×</button>
                                <div class="card-header">
                                    <h4 class="card-title" contenteditable="true" data-card-id="{{ card.id }}" onblur="updateCardTitle(this)">{{ card.title }}</h4>
                                </div>
                                <div class="card-footer">
                                    <div class="card-tags-section">
                                        <div class="card-tags-header">
                                            <span class="card-tags-label">tags ({{ card.tags|length }})</span>
                                        </div>
                                        <div class="card-tags">
                            {% for tag in card.tags %}
                            <span class="card-tag" data-tag="{{ tag }}" style="--tag-index: {{ tag_order.index(tag) if tag in tag_order else 0 }}"><span class="tag-color-dot"></span>{{ tag }} <span class="tag-remove" onclick="removeTagFromCard('{{ card.id }}', '{{ tag }}', this)">×</span></span>
                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-cell">∅</div>
                    {% endif %}
                    <button class="grid-cell-add-button" onclick="createNewCard('other', null)" title="Add card to this cell">+</button>
                </div>
            </div>
        </div>

    {% else %}
        <!-- 0D Grid: No dimensional tags - single cell for all cards -->
        <div class="dimensional-grid zero-dimensional {% if show_expanded %}cards-expanded{% endif %} {% if show_colors %}show-colors{% endif %}" data-palette="{{ color_palette|default('muji') }}">
            <div class="grid-cell" data-row="all" data-col="all">
                {% for card in cards %}
                <div class="card-item" data-card-id="{{ card.id }}">
                    <div class="card-content">
                        <button class="card-delete" onclick="deleteCard('{{ card.id }}', this)" title="Delete card">×</button>
                        <div class="card-header">
                            <h4 class="card-title" contenteditable="true" data-card-id="{{ card.id }}" onblur="updateCardTitle(this)">{{ card.title }}</h4>
                        </div>
                        <div class="card-footer">
                            <div class="card-tags-section">
                                <div class="card-tags-header">
                                    <span class="card-tags-label">tags ({{ card.tags|length }})</span>
                                </div>
                                <div class="card-tags">
                                    {% for tag in card.tags %}
                                    <span class="card-tag" data-tag="{{ tag }}" style="--tag-index: {{ tag_order.index(tag) if tag in tag_order else 0 }}"><span class="tag-color-dot"></span>{{ tag }} <span class="tag-remove" onclick="removeTagFromCard('{{ card.id }}', '{{ tag }}', this)">×</span></span>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                <button class="grid-cell-add-button" onclick="createNewCard(null, null)" title="Add card to this cell">+</button>
            </div>
        </div>
    {% endif %}
</div>
